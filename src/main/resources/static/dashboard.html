<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synai Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .metric:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .metric-label {
            color: #666;
            font-weight: 500;
        }

        .metric-value {
            color: #333;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .metric-value.highlight {
            color: #667eea;
            font-size: 1.3rem;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .chart-container h3 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.3rem;
        }

        .controls {
            text-align: center;
            margin-bottom: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0 10px;
            transition: transform 0.2s ease;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.2rem;
            margin: 50px 0;
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .success {
            background: #51cf66;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .timestamp {
            text-align: center;
            color: white;
            opacity: 0.8;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Synai Analytics Dashboard</h1>
            <p>Real-time insights into user behavior and AI performance</p>
        </div>

        <div class="controls">
            <button class="btn" onclick="refreshData(true)">üîÑ Refresh Data</button>
            <button class="btn" onclick="createTestData()">üìù Create Test Data</button>
            <button class="btn" onclick="createHistoricalData()">üìÖ Add Historical Data</button>
            <button class="btn" onclick="clearData()">üóëÔ∏è Clear All Data</button>
        </div>

        <div id="loading" class="loading">
            Loading analytics data...
        </div>

        <div id="error" class="error" style="display: none;"></div>
        <div id="success" class="success" style="display: none;"></div>

        <div id="dashboard" style="display: none;">
            <div class="dashboard-grid">
                <!-- User Metrics Card -->
                <div class="card">
                    <h3>üë• User Metrics</h3>
                    <div class="metric">
                        <span class="metric-label">Total Users</span>
                        <span class="metric-value highlight" id="totalUsers">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Daily Active Users</span>
                        <span class="metric-value" id="dailyActiveUsers">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Weekly Active Users</span>
                        <span class="metric-value" id="weeklyActiveUsers">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Monthly Active Users</span>
                        <span class="metric-value" id="monthlyActiveUsers">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">New Users Today</span>
                        <span class="metric-value" id="newUsers">-</span>
                    </div>
                </div>

                <!-- Message Metrics Card -->
                <div class="card">
                    <h3>üí¨ Message Metrics</h3>
                    <div class="metric">
                        <span class="metric-label">Total Messages</span>
                        <span class="metric-value highlight" id="totalMessages">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">User Messages</span>
                        <span class="metric-value" id="userMessages">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Assistant Messages</span>
                        <span class="metric-value" id="assistantMessages">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Avg Message Length</span>
                        <span class="metric-value" id="averageMessageLength">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Avg Response Time</span>
                        <span class="metric-value" id="averageResponseTime">-</span>
                    </div>
                </div>

                <!-- Engagement Metrics Card -->
                <div class="card">
                    <h3>üìà Engagement Metrics</h3>
                    <div class="metric">
                        <span class="metric-label">Onboarding Rate</span>
                        <span class="metric-value highlight" id="onboardingCompletionRate">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Top MBTI Type</span>
                        <span class="metric-value" id="topMbtiType">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Messages per User</span>
                        <span class="metric-value" id="messagesPerUser">-</span>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="chart-container">
                <h3>üìä Message Activity Over Time</h3>
                <canvas id="messageChart" width="400" height="200"></canvas>
            </div>

            <div class="chart-container">
                <h3>üéØ User Distribution by MBTI</h3>
                <canvas id="mbtiChart" width="400" height="200"></canvas>
            </div>
        </div>

        <div class="timestamp" id="lastUpdated">
            Last updated: Never
        </div>
    </div>

    <script>
        let messageChart, mbtiChart;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
        });

        async function refreshData(showSuccessMessage = false) {
            try {
                showLoading(true);
                hideMessages();

                const response = await fetch('/api/analytics/summary');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                updateDashboard(data);
                
                if (showSuccessMessage) {
                    showSuccess('Data refreshed successfully!');
                }
                
            } catch (error) {
                console.error('Error fetching data:', error);
                showError('Failed to load analytics data: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function updateDashboard(data) {
            // Update user metrics
            document.getElementById('totalUsers').textContent = data.totalUsers || 0;
            document.getElementById('dailyActiveUsers').textContent = data.dailyActiveUsers || 0;
            document.getElementById('weeklyActiveUsers').textContent = data.weeklyActiveUsers || 0;
            document.getElementById('monthlyActiveUsers').textContent = data.monthlyActiveUsers || 0;
            document.getElementById('newUsers').textContent = data.newUsers || 0;

            // Update message metrics
            document.getElementById('totalMessages').textContent = data.totalMessages || 0;
            document.getElementById('userMessages').textContent = data.userMessages || 0;
            document.getElementById('assistantMessages').textContent = data.assistantMessages || 0;
            document.getElementById('averageMessageLength').textContent = 
                data.averageMessageLength ? Math.round(data.averageMessageLength) + ' chars' : '0 chars';
            document.getElementById('averageResponseTime').textContent = 
                data.averageResponseTime ? Math.round(data.averageResponseTime) + 'ms' : '0ms';

            // Update engagement metrics
            document.getElementById('onboardingCompletionRate').textContent = 
                data.onboardingCompletionRate ? Math.round(data.onboardingCompletionRate) + '%' : '0%';
            document.getElementById('topMbtiType').textContent = data.topMbtiType || 'N/A';
            
            // Calculate messages per user
            const messagesPerUser = data.totalUsers > 0 ? 
                Math.round((data.totalMessages || 0) / data.totalUsers * 10) / 10 : 0;
            document.getElementById('messagesPerUser').textContent = messagesPerUser;

            // Update timestamp
            document.getElementById('lastUpdated').textContent = 
                'Last updated: ' + new Date().toLocaleString();

            // Show dashboard
            document.getElementById('dashboard').style.display = 'block';

            // Update charts (simplified for now)
            updateCharts(data);
        }

        async function updateCharts(data) {
            // Simple message activity chart
            const messageCtx = document.getElementById('messageChart').getContext('2d');
            if (messageChart) {
                messageChart.destroy();
            }
            
            messageChart = new Chart(messageCtx, {
                type: 'doughnut',
                data: {
                    labels: ['User Messages', 'Assistant Messages'],
                    datasets: [{
                        data: [data.userMessages || 0, data.assistantMessages || 0],
                        backgroundColor: ['#667eea', '#764ba2'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // MBTI distribution chart with real data
            const mbtiCtx = document.getElementById('mbtiChart').getContext('2d');
            if (mbtiChart) {
                mbtiChart.destroy();
            }
            
            try {
                const mbtiResponse = await fetch('/api/analytics/mbti-distribution');
                const mbtiData = await mbtiResponse.json();
                
                const labels = Object.keys(mbtiData);
                const values = Object.values(mbtiData);
                
                mbtiChart = new Chart(mbtiCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Users',
                            data: values,
                            backgroundColor: '#667eea',
                            borderColor: '#764ba2',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading MBTI data:', error);
                // Fallback to empty chart
                mbtiChart = new Chart(mbtiCtx, {
                    type: 'bar',
                    data: {
                        labels: ['No Data'],
                        datasets: [{
                            label: 'Users',
                            data: [0],
                            backgroundColor: '#667eea'
                        }]
                    },
                    options: {
                        responsive: true
                    }
                });
            }
        }

        async function createTestData() {
            try {
                showLoading(true);
                const response = await fetch('/api/test-data/create-sample-messages');
                const result = await response.json();
                showSuccess(`Test data created: ${result.totalMessages} messages added!`);
                setTimeout(refreshData, 1000);
            } catch (error) {
                showError('Failed to create test data: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function createHistoricalData() {
            try {
                showLoading(true);
                const response = await fetch('/api/test-data/create-historical-messages');
                const result = await response.json();
                showSuccess(`Historical data created: ${result.totalMessages} messages added!`);
                setTimeout(refreshData, 1000);
            } catch (error) {
                showError('Failed to create historical data: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function clearData() {
            if (confirm('Are you sure you want to clear all message data?')) {
                try {
                    showLoading(true);
                    const response = await fetch('/api/test-data/clear-all-messages', { method: 'DELETE' });
                    const result = await response.json();
                    showSuccess(`Data cleared: ${result.deletedCount} messages removed!`);
                    setTimeout(refreshData, 1000);
                } catch (error) {
                    showError('Failed to clear data: ' + error.message);
                } finally {
                    showLoading(false);
                }
            }
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('dashboard').style.display = show ? 'none' : 'block';
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        function hideMessages() {
            document.getElementById('error').style.display = 'none';
            document.getElementById('success').style.display = 'none';
        }

        // Auto-refresh every 60 seconds
        setInterval(refreshData, 60000);
    </script>
</body>
</html>
